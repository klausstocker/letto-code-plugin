<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Python Code Runner</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='styles.css') }}">
    <link rel="icon" href="{{ url_for('static', filename='atom.ico') }}" type="image/x-icon">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/ace/1.4.12/ace.js"></script>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
</head>
<body>
    <div id="file-info">
        UnitTest.py
    </div>
    <div class="container">
        <div id="UnitTestEditor" contenteditable="true" style="height: 300px; width:"></div>
        <div id="UnitTestOutput"></div>
    </div>
    <div id="file-info">
        main.py
    </div>
    <div class="container">
        <div id="editor" contenteditable="true"></div>
        <div id="output"></div>
    </div>
    <div class="btn-container">
        <button class="black-button" id="runButton">
            <span id="buttonText">Run Code</span>
            <i class="fas fa-circle-notch fa-spin" id="loadingIcon" style="display: none; margin-left: 10px;"></i>
        </button>  
    </div>
    <div class="btn-container">
        <button class="black-button" id="lintButton">
            <span id="buttonText">Lint Code</span>
            <i class="fas fa-circle-notch fa-spin" id="loadingIcon" style="display: none; margin-left: 10px;"></i>
        </button>  
    </div>
    <div class="btn-container">
        <button class="black-button" id="checkButton">
            <span id="buttonText">Check Code</span>
            <i class="fas fa-circle-notch fa-spin" id="loadingIcon" style="display: none; margin-left: 10px;"></i>
        </button>  
    </div>
    <form action="" method="" id="uploadForm" enctype="multipart/form-data">
        <label for="file">File (extensions are removed)</label>
        <input id="file" name="file" type="file" />
        <button id="upload" type="button" onclick="onUpload()" >Upload</button>
    </form>
    <script>
        async function onUpload()
        {
            console.log('step 1');
            const form = document.getElementById('uploadForm');
            const formData = new FormData(form);

            try {
                const response = await fetch('/upload', {
                    method: 'POST',
                    body: formData
                });
                console.log(response);
                if (response.ok) {
                    const data = await response.text();
                    console.log(data);
                } else {
                    console.log('error');
                }
            } catch (error) {
                console.log(error);
            }
        }
    </script>
    <script>
        var UnitTestEditor = ace.edit("UnitTestEditor");
        UnitTestEditor.setTheme("ace/theme/monokai");
        UnitTestEditor.session.setMode("ace/mode/python");
        UnitTestEditor.getSession().setValue(`

def correctImplementation(arg1, arg2):
    sum = arg1 + arg2
    print(f'the sum is {sum}')
    return sum

class Checker(unittest.TestCase): # do not rename
    def test_return(self): # names must start with 'test_'
        args = (1, 2)
        student_result = calculate_sum(*args) # call to students implementation 
        expected_result = correctImplementation(*args)
        self.assertEqual(student_result, expected_result)
        
    def test_output(self):
        args = (3, 4)
        with RedirectedStdout() as student_out:
            calculate_sum(*args)
        with RedirectedStdout() as expected_out:
            correctImplementation(*args)
        self.assertEqual(str(student_out), str(expected_out))
`);

        var editor = ace.edit("editor");
        editor.setTheme("ace/theme/monokai");
        editor.session.setMode("ace/mode/python");
        editor.getSession().setValue(`
def calculate_sum(a, b):
    print('the sum is ' + str(a + b))
    return a + b
`);

        $("#runButton").click(function() {
            var code = editor.getValue();
            $.ajax({
                url: '/run',
                method: 'POST',
                contentType: 'application/json',
                data: JSON.stringify({code: code}),
                success: function(response) {
                    $("#output").text(response.output);
                }
            });
        });
        $("#lintButton").click(function() {
            var code = editor.getValue();
            $.ajax({
                url: '/lint',
                method: 'POST',
                contentType: 'application/json',
                data: JSON.stringify({code: code}),
                success: function(response) {
                    $("#output").text(response.output);
                }
            });
        });
        $("#checkButton").click(function() {
            var code = editor.getValue();
            var testcode = UnitTestEditor.getValue();
            $.ajax({
                url: '/check',
                method: 'POST',
                contentType: 'application/json',
                data: JSON.stringify({code: code, testcode: testcode}),
                success: function(response) {
                    $("#UnitTestOutput").text(response.output);
                }
            });
        });
    </script>
    <script>
        document.getElementById("runButton").addEventListener("click", function() {
            var loadingIcon = document.getElementById("loadingIcon");

            // Show the loading icon
            loadingIcon.style.display = "inline-block";

            // Hide the loading icon after 2 seconds
            setTimeout(function() {
                loadingIcon.style.display = "none";
            }, 1000);
        });
    </script>
</body>
</html>